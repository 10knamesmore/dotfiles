#!/usr/bin/env bash
###############################################################################
# 包管理器安装脚本
###############################################################################

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
DRY_RUN=false

info() { echo -e "\033[0;32m[info]\033[0m: $1"; }
warn() { echo -e "\033[1;33m[warn]\033[0m: $1"; }
error() { echo -e "\033[0;31m[error]\033[0m: $1"; }
error_exit() {
    error "$1"
    exit 1
}

detect_os() {
    case "$(uname)" in
    Darwin) echo "macos" ;;
    Linux) echo "linux" ;;
    *) echo "other" ;;
    esac
}

install_macos() {
    info "安装 macOS 包..."

    if ! command -v brew &>/dev/null; then
        warn "Homebrew 未安装"
        if [[ "$DRY_RUN" == true ]]; then
            info "[DRY RUN] 将安装 Homebrew"
        else
            error "请先安装 Homebrew"
            exit 1
            # info "正在安装 Homebrew..."
            # /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
    fi

    local brewfile="$DOTFILES_DIR/macos/Brewfile"
    [[ ! -f "$brewfile" ]] && error_exit "Brewfile 不存在: $brewfile"

    if [[ "$DRY_RUN" == true ]]; then
        info "[DRY RUN] 将执行: brew bundle install --file=$brewfile"
        grep -E '^(tap|brew|cask|mas) ' "$brewfile" | sed 's/^/  /'
    else
        brew bundle install --file="$brewfile"
        info "✓ Homebrew 包安装完成"
    fi
}

install_pacman() {
    info "使用 pacman 安装包..."
    local pacman_file="$DOTFILES_DIR/linux/pacman.txt"
    local pacman_aur="$DOTFILES_DIR/linux/pacman-aur.txt"

    if [[ -f "$pacman_file" ]]; then
        if [[ "$DRY_RUN" == true ]]; then
            info "[DRY RUN] 将安装官方包:"
            cat "$pacman_file" | sed 's/^/  /'
        else
            sudo pacman -Syyu --needed --noconfirm - <"$pacman_file"
            info "✓ 官方包安装完成"
        fi
    fi

    if [[ -f "$pacman_aur" ]]; then
        if command -v yay &>/dev/null; then
            [[ "$DRY_RUN" == true ]] && info "[DRY RUN] AUR:" && cat "$pacman_aur" | sed 's/^/  /' || yay -S --needed --noconfirm - <"$pacman_aur"
        elif command -v paru &>/dev/null; then
            [[ "$DRY_RUN" == true ]] && info "[DRY RUN] AUR:" && cat "$pacman_aur" | sed 's/^/  /' || paru -S --needed --noconfirm - <"$pacman_aur"
        else
            warn "未安装 AUR helper，跳过 AUR 包"
        fi
    fi
}

main() {
    while [[ $# -gt 0 ]]; do
        case $1 in
        --dry)
            DRY_RUN=true
            shift
            ;;
        -h | --help)
            echo "用法: $0 [--dry-run]"
            exit 0
            ;;
        *)
            error "未知选项: $1"
            exit 1
            ;;
        esac
    done

    os=$(detect_os)
    info "检测到系统: $os"
    [[ "$DRY_RUN" == true ]] && warn "DRY RUN 模式"

    case "$os" in
    macos) install_macos ;;
    linux) install_pacman ;;
    *) error_exit "不支持的操作系统" ;;
    esac

    info "✓ 完成！"
}

main "$@"
